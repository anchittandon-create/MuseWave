#!/bin/bash

# MuseForge Pro - Test Script
# Verifies all components are working correctly

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                           â•‘"
echo "â•‘  ğŸ§ª  MuseForge Pro - System Test  ğŸ§ª                     â•‘"
echo "â•‘                                                           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

PASSED=0
FAILED=0

# Helper function
test_command() {
    local name=$1
    local command=$2
    
    echo -n "Testing $name... "
    if eval "$command" > /dev/null 2>&1; then
        echo "âœ… PASS"
        ((PASSED++))
    else
        echo "âŒ FAIL"
        ((FAILED++))
    fi
}

# System binaries
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "System Binaries"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

test_command "FFmpeg" "ffmpeg -version"
test_command "FFprobe" "ffprobe -version"
test_command "FluidSynth" "fluidsynth --version"
test_command "Python 3" "python3 --version"
test_command "Node.js" "node --version"
test_command "npm" "npm --version"

echo ""

# Python packages
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Python Packages"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ -d "venv" ]; then
    source venv/bin/activate
    
    test_command "Riffusion" "python -c 'import riffusion'"
    test_command "Magenta" "python -c 'import magenta'"
    test_command "Coqui TTS" "python -c 'import TTS'"
    test_command "PyTorch" "python -c 'import torch'"
else
    echo "âŒ Virtual environment not found. Run setup.sh first."
    FAILED=$((FAILED + 4))
fi

echo ""

# Files
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Required Files"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

test_command "SoundFont" "test -f assets/GeneralUser.sf2"
test_command ".env file" "test -f .env"
test_command "node_modules" "test -d node_modules"
test_command "package.json" "test -f package.json"

echo ""

# TypeScript compilation
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "TypeScript Compilation"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo -n "Compiling TypeScript... "
if npm run build > /dev/null 2>&1; then
    echo "âœ… PASS"
    ((PASSED++))
else
    echo "âŒ FAIL"
    ((FAILED++))
fi

echo ""

# API test (if server is running)
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "API Endpoints (optional - only if server running)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo -n "Testing /health endpoint... "
if curl -s http://localhost:4000/health > /dev/null 2>&1; then
    echo "âœ… PASS"
    
    echo ""
    echo "Health check response:"
    curl -s http://localhost:4000/health | python -m json.tool
else
    echo "âš ï¸  SKIP (server not running)"
fi

echo ""

# Summary
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                     Test Summary                          â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "  âœ… Passed: $PASSED"
echo "  âŒ Failed: $FAILED"
echo ""

if [ $FAILED -eq 0 ]; then
    echo "ğŸ‰ All tests passed! Ready to generate music."
    echo ""
    echo "Start the server with:"
    echo "  source venv/bin/activate"
    echo "  npm run dev"
    exit 0
else
    echo "âš ï¸  Some tests failed. Check SETUP_MODELS.md for troubleshooting."
    exit 1
fi
